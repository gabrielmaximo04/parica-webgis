<!DOCTYPE html> 
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<title>Programa Paric√°</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">

<style>
  html, body { margin:0; height:100%; }
  body { font-family:'Poppins', sans-serif; }
  #map { width:100%; height:100vh; background:#eaeaea; }

  .header{
    position:fixed; top:20px; left:80px; z-index:2000;
    background:transparent; pointer-events:none;
  }
  .header img{
    height:90px; object-fit:contain; display:block;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
  }

  .north{
    position:absolute; top:20px; right:20px; z-index:2000;
    display:flex; flex-direction:column; align-items:center;
    background:transparent; pointer-events:none;
  }
  .north-letter{ font-weight:600; font-size:16px; color:#8D3A08; margin-bottom:2px; }
  .north img{ height:45px; display:block; }

  .popup-title{ font-weight:600; margin-bottom:6px; }
  .popup-table{ border-collapse:collapse; width:100%; }
  .popup-table td{ padding:3px 6px; border-top:1px solid #eee; vertical-align:top; }
  .popup-key{ font-weight:600; white-space:nowrap; }

  .leaflet-control-scale{ margin-right:12px !important; margin-bottom:12px !important; }

  /* Basemap (minimizado) */
  .basemap-ctrl{
    position:absolute; right:12px; bottom:54px; z-index:1500;
    background: rgba(255,255,255,0.50);
    backdrop-filter: blur(3px);
    border: 1px solid rgba(255,255,255,0.4);
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.18);
    overflow:hidden;
    min-width:170px;
  }
  .basemap-head{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; padding:10px 12px; cursor:pointer; user-select:none; font-weight:600;
  }
  .basemap-body{ padding:0 12px 10px 12px; display:none; }
  .basemap-ctrl.open .basemap-body{ display:block; }
  .basemap-row{ display:flex; align-items:center; gap:8px; margin:6px 0; font-size:13px; }

  /* Legenda (minimizada) */
  .legend-ctrl{
    position:absolute; left:12px; bottom:12px; z-index:1500;
    background: rgba(255,255,255,0.50);
    backdrop-filter: blur(3px);
    border: 1px solid rgba(255,255,255,0.4);
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.18);
    overflow:hidden;
    min-width:360px;
    max-width:520px;
  }
  .legend-head{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; padding:10px 12px; cursor:pointer; user-select:none; font-weight:600;
  }
  .legend-body{ padding:0 12px 10px 12px; display:none; }
  .legend-ctrl.open .legend-body{ display:block; }
  .legend-row{
    display:flex; align-items:flex-start; gap:10px;
    padding:6px 0; font-size:13px; line-height:1.25;
  }
  .legend-row input{ margin-top:2px; }
  .swatch{
    width:16px; height:16px; border-radius:4px; flex:0 0 auto;
    box-shadow:0 0 0 2px rgba(0,0,0,0.08);
  }
  .swatch-dot{
    width:12px; height:12px; border-radius:50%; flex:0 0 auto;
    border:2px solid #fff; box-shadow:0 0 0 2px rgba(0,0,0,0.10);
  }
  .chev{ font-weight:600; opacity:0.8; }
    /* ===== Busca ===== */
  .search-ctrl{
    position:absolute;
    left:50%;
    transform: translateX(-50%);
    top:12px;
    z-index:1600;
    min-width: 420px;
    max-width: 520px;
    background: rgba(255,255,255,0.75);
    backdrop-filter: blur(3px);
    border: 1px solid rgba(255,255,255,0.55);
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.18);
    overflow:hidden;
  }
  .search-head{
    display:flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
  }
  .search-input{
    width:100%;
    border:none;
    outline:none;
    font-family:'Poppins', sans-serif;
    font-size:13px;
    background:transparent;
  }
  .search-results{
    border-top:1px solid rgba(0,0,0,0.06);
    max-height: 220px;
    overflow:auto;
    display:none;
  }
  .search-ctrl.open .search-results{ display:block; }

  .search-item{
    padding:8px 12px;
    cursor:pointer;
    font-size:13px;
    line-height:1.2;
  }
  .search-item:hover{ background: rgba(0,0,0,0.05); }
  .search-item small{ opacity:0.75; display:block; margin-top:2px; }
  .search-pill{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    background: rgba(0,0,0,0.06);
    white-space:nowrap;
  }
</style>
</head>

<body>
  <div class="header"><img src="logo_parica.png" alt="Programa Paric√°"></div>

  <div class="north">
    <span class="north-letter">N</span>
    <img src="norte.png" alt="Norte">
  </div>

  <div id="map"></div>

  <!-- Seus dados -->
  <script src="Solucoes_locais.js"></script>
  <script src="Co-labora.js"></script>
  <script src="Fronteiras_T2.js"></script>
  <script src="Agenda_Publica.js"></script>
  <script src="Unidades_Conservacao.js"></script>
  <script src="Terra_indigena.js"></script>
  <script src="Municipios.js"></script>

<script>
  // ===== POPUP =====
  function escapeHtml(v){
    if(v===null||v===undefined) return '';
    return String(v)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");
  }
  function getDriveIdFromValue(v){
    if(!v) return '';
    var s = String(v).trim();

    // j√° √© ID puro
    if(/^[a-zA-Z0-9_-]{20,}$/.test(s)) return s;

    // extrai de URL do Drive
    var m = s.match(/\/file\/d\/([^\/\?]+)/);
    if(m && m[1]) return m[1];

    m = s.match(/[?&]id=([^&]+)/);
    if(m && m[1]) return m[1];

    return '';
  }

  function driveViewUrl(id){
    return 'https://drive.google.com/file/d/' + encodeURIComponent(id) + '/view?usp=sharing';
  }

  function driveDownloadUrl(id){
    return 'https://drive.google.com/uc?export=download&id=' + encodeURIComponent(id);
  }
  // üî¥ BLACKLIST (a sua)
  var POPUP_BLACKLIST = new Set([
    'OBJECTID','FID','Shape_Leng','Shape_Area','created_at','updated_at','gid',
    'terrai_cod','undadm_cod','undadm_nom','undadm_sig','dominio_un','epsg',
    'superficie','id','version','inserted_a', 'drive_id', 'category'
  ]);

  function buildPopupHtml(props, titulo){
    if(!props) return '<div class="popup-title">'+escapeHtml(titulo)+'</div>(sem atributos)';

    var keys = Object.keys(props).filter(function(k){
      if(POPUP_BLACKLIST.has(k)) return false;
      var v = props[k];
      if(v===null || v===undefined) return false;
      if(String(v).trim()==='') return false;
      return true;
    });

    if(!keys.length) return '<div class="popup-title">'+escapeHtml(titulo)+'</div>(sem atributos)';

    keys.sort(function(a,b){ return a.localeCompare(b,'pt-BR'); });

    var h = '<div class="popup-title">'+escapeHtml(titulo)+'</div>';

    // üî• BLOCO DO GOOGLE DRIVE ‚Äî COLE AQUI
    var driveId = getDriveIdFromValue(props.drive_id || props.DRIVE_ID || '');

    if(driveId){
      h += `
        <div style="margin:6px 0 10px 0;">
          <a href="${driveViewUrl(driveId)}" target="_blank" rel="noopener"
            style="display:inline-block;padding:6px 10px;background:#8D3A08;color:#fff;
                    border-radius:6px;text-decoration:none;font-size:12px;font-weight:600;">
            üìÑ Abrir arquivo
          </a>
          &nbsp;
          <a href="${driveDownloadUrl(driveId)}" target="_blank" rel="noopener"
            style="display:inline-block;padding:6px 10px;background:#666;color:#fff;
                    border-radius:6px;text-decoration:none;font-size:12px;font-weight:600;">
            ‚¨áÔ∏è Baixar
          </a>
        </div>
      `;
    }

    // üëá tabela come√ßa aqui
    h += '<table class="popup-table">';

    keys.forEach(function(k){
      h += '<tr><td class="popup-key">'+escapeHtml(k)+'</td><td>'+escapeHtml(props[k])+'</td></tr>';
    });

    return h + '</table>';
  }

  // ===== MAPA =====
  var map = L.map('map');
  map.setView([-5.5, -49.5], 7); // garante que sempre aparece algo

  // ===== BASEMAPS =====
  var bmOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'¬© OpenStreetMap', maxZoom:19
  });

  var bmCarto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution:'¬© OpenStreetMap ¬© CARTO', maxZoom:20
  });

  var bmSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution:'Tiles ¬© Esri', maxZoom:19
  });

  bmOSM.addTo(map);
  L.control.scale({ position:'bottomright', metric:true, imperial:false }).addTo(map);

  // ===== CORES =====
  var C_COLABORA   = '#AC5A0E';
  var C_FRONTEIRAS = '#274703';
  var C_AGENDA     = '#f4cb0a';
  var C_SOLUCOES   = '#8D3A08';
  var C_UC         = '#f4de78';
  var C_TI         = '#B2C84B';
  var C_MUN        = '#999999';

  var O_COLABORA = 0.60;
  var O_FRONTEIRAS = 0.60;
  var O_AGENDA = 0.60;
  var O_UC = 0.20;
  var O_TI = 0.20;

  var MUNICIPIOS_DESTAQUE = new Set([
    'Abel Figueiredo',
    'Bom Jesus do Tocantins',
    'Rondon do Par√°',
    'Dom Eliseu',
    'S√£o Jo√£o do Araguaia'
  ]);
  // ===== helper: cria camada s√≥ se existir dado =====
  function safeGeoJSON(dataVarName, opts){
    var data = window[dataVarName];
    if(!data){
      console.warn('Camada n√£o carregou:', dataVarName);
      return null;
    }
    return L.geoJSON(data, opts);
  }

  var camadaColabora = safeGeoJSON('dadosGeoJSON', {
    style:{ color:C_COLABORA, weight:1, fillColor:C_COLABORA, fillOpacity:O_COLABORA },
    onEachFeature:function(f,l){ l.bindPopup(buildPopupHtml(f.properties,'Co-Labora'), {maxWidth:420}); }
  });

  var camadaFronteiras = safeGeoJSON('dadosGeoJSON_fronteiras', {
    style:{ color:C_FRONTEIRAS, weight:1, fillColor:C_FRONTEIRAS, fillOpacity:O_FRONTEIRAS },
    onEachFeature:function(f,l){ l.bindPopup(buildPopupHtml(f.properties,'Fronteiras T2'), {maxWidth:420}); }
  });

  var camadaAgenda = safeGeoJSON('dadosGeoJSON_agendaPublica', {
    style:{ color:C_AGENDA, weight:1, fillColor:C_AGENDA, fillOpacity:O_AGENDA },
    onEachFeature:function(f,l){ l.bindPopup(buildPopupHtml(f.properties,'Agenda P√∫blica'), {maxWidth:420}); }
  });

  var camadaUC = safeGeoJSON('dadosGeoJSON_UC', {
    style:{ color:C_UC, weight:1, fillColor:C_UC, fillOpacity:O_UC },
    onEachFeature:function(f,l){ l.bindPopup(buildPopupHtml(f.properties,'Unidades de Conserva√ß√£o'), {maxWidth:420}); }
  });

  var camadaTI = safeGeoJSON('dadosGeoJSON_TI', {
    style:{ color:C_TI, weight:1, fillColor:C_TI, fillOpacity:O_TI },
    onEachFeature:function(f,l){ l.bindPopup(buildPopupHtml(f.properties,'Terra Ind√≠gena'), {maxWidth:420}); }
  });

  var camadaMunicipios = safeGeoJSON('dadosGeoJSON_municipios', {
    interactive:false,
    style:{ color:C_MUN, weight:0.7, fillColor:C_MUN, fillOpacity:0.0}
  });

  var MUNICIPIO_FIELD = 'NM_MUN'; // ‚Üê CONFIRME NO CONSOLE

  var camadaMunicipiosDestaque = L.geoJSON(dadosGeoJSON_municipios, {
    interactive: false,

    filter: function(feature){
      var nome = feature.properties && feature.properties[MUNICIPIO_FIELD]
        ? String(feature.properties[MUNICIPIO_FIELD]).trim()
        : '';
      return MUNICIPIOS_DESTAQUE.has(nome);
    },

    style: function(){
      return {
        color: '#BC8524',   // üî• cor destaque PPA
        weight: 3,
        fillOpacity: 0
      };
    }
  });

  var camadaSolucoes = safeGeoJSON('dadosGeoJSON_Solucoes_locais', {
    pointToLayer:function(feature, latlng){
      return L.circleMarker(latlng,{
        radius:3, color:'#ffffff', weight:1, fillColor:C_SOLUCOES, fillOpacity:0.9
      });
    },
    onEachFeature:function(f,l){ l.bindPopup(buildPopupHtml(f.properties,'Solu√ß√µes Locais'), {maxWidth:420}); }
  });

  // ===== Liga s√≥ o que existe =====
  [
    camadaColabora, camadaFronteiras, camadaAgenda, camadaSolucoes,
    camadaMunicipios, camadaMunicipiosDestaque,camadaUC, camadaTI
  ].forEach(function(layer){
    if(layer) layer.addTo(map);
  });

  // Ordem (fund√£o)
  function enforceBackLayers(){
    if(camadaUC && map.hasLayer(camadaUC)) camadaUC.bringToBack();
    if(camadaTI && map.hasLayer(camadaTI)) camadaTI.bringToBack();
    if(camadaMunicipios && map.hasLayer(camadaMunicipios)) camadaMunicipios.bringToBack();
    if(map.hasLayer(camadaMunicipiosDestaque)) camadaMunicipiosDestaque.bringToFront();
  }
  enforceBackLayers();

  // Zoom no que est√° ativo
  function fitToActive(){
    var ativos=[];
    if(camadaColabora && map.hasLayer(camadaColabora)) ativos.push(camadaColabora);
    if(camadaFronteiras && map.hasLayer(camadaFronteiras)) ativos.push(camadaFronteiras);
    if(camadaAgenda && map.hasLayer(camadaAgenda)) ativos.push(camadaAgenda);
    if(camadaSolucoes && map.hasLayer(camadaSolucoes)) ativos.push(camadaSolucoes);

    if(!ativos.length) return;

    var b = L.featureGroup(ativos).getBounds();
    if(b.isValid()) map.fitBounds(b, {padding:[20,20]});
  }
  fitToActive();

  // ===== UI: Basemap minimizado =====
  var basemapCtrl = document.createElement('div');
  basemapCtrl.className = 'basemap-ctrl';
  basemapCtrl.innerHTML = `
    <div class="basemap-head">
      <span>Basemap</span><span class="chev">‚Ä∫</span>
    </div>
    <div class="basemap-body">
      <label class="basemap-row"><input type="radio" name="bm" value="osm" checked> OpenStreetMap</label>
      <label class="basemap-row"><input type="radio" name="bm" value="carto"> Carto Light</label>
      <label class="basemap-row"><input type="radio" name="bm" value="sat"> Sat√©lite</label>
    </div>
  `;
  document.body.appendChild(basemapCtrl);

  basemapCtrl.querySelector('.basemap-head').addEventListener('click', function(){
    basemapCtrl.classList.toggle('open');
    basemapCtrl.querySelector('.chev').textContent = basemapCtrl.classList.contains('open') ? '‚åÑ' : '‚Ä∫';
  });

  function setBasemap(which){
    map.removeLayer(bmOSM); map.removeLayer(bmCarto); map.removeLayer(bmSat);
    if(which==='osm') bmOSM.addTo(map);
    if(which==='carto') bmCarto.addTo(map);
    if(which==='sat') bmSat.addTo(map);
  }
  basemapCtrl.querySelectorAll('input[name="bm"]').forEach(function(r){
    r.addEventListener('change', function(){ setBasemap(this.value); });
  });

  // ===== UI: Legenda minimizada com CHECKBOX =====
  var legendCtrl = document.createElement('div');
  legendCtrl.className = 'legend-ctrl open';

  function legendRow(id, checked, swatchHtml, labelText){
    return `
      <div class="legend-row">
        <input type="checkbox" id="${id}" ${checked ? 'checked' : ''}>
        ${swatchHtml}
        <label for="${id}">${labelText}</label>
      </div>
    `;
  }

  var legendBody = '';
  if(camadaColabora)   legendBody += legendRow('ck_colabora', true,  `<span class="swatch" style="background: rgba(172,90,14,${O_COLABORA}); border:1px solid ${C_COLABORA};"></span>`, 'Co-Labora - Fomento √† uma economia sustent√°vel e inclusiva');
  if(camadaFronteiras) legendBody += legendRow('ck_fronteiras', true,`<span class="swatch" style="background: rgba(39,71,3,${O_FRONTEIRAS}); border:1px solid ${C_FRONTEIRAS};"></span>`, 'Fortalecimento de Redes de Comercializa√ß√£o e Abertura de Mercados');
  if(camadaAgenda)     legendBody += legendRow('ck_agenda', true,    `<span class="swatch" style="background: rgba(244,203,10,${O_AGENDA}); border:1px solid ${C_AGENDA};"></span>`, 'Desenvolvimento Territorial Rural por Meio de Sistemas Agroflorestais');
  if(camadaSolucoes)   legendBody += legendRow('ck_solucoes', true,  `<span class="swatch-dot" style="background:${C_SOLUCOES};"></span>`, 'Solu√ß√µes Locais');
  if(camadaUC)         legendBody += legendRow('ck_uc', true,        `<span class="swatch" style="background: rgba(244,222,120,${O_UC}); border:1px solid ${C_UC};"></span>`, 'Unidade de Conserva√ß√£o');
  if(camadaTI)         legendBody += legendRow('ck_ti', true,        `<span class="swatch" style="background: rgba(178,200,75,${O_TI}); border:1px solid ${C_TI};"></span>`, 'Terra Ind√≠gena');
  if(camadaMunicipios) legendBody += legendRow('ck_mun', true,       `<span class="swatch" style="background: rgba(170,170,170,0.10); border:1px solid ${C_MUN};"></span>`, 'Munic√≠pios');

  legendCtrl.innerHTML = `
    <div class="legend-head">
      <span>Legenda</span><span class="chev">‚åÑ</span>
    </div>
    <div class="legend-body">${legendBody}</div>
  `;
  document.body.appendChild(legendCtrl);

  legendCtrl.querySelector('.legend-head').addEventListener('click', function(){
    legendCtrl.classList.toggle('open');
    legendCtrl.querySelector('.chev').textContent = legendCtrl.classList.contains('open') ? '‚åÑ' : '‚Ä∫';
  });

  function bindToggle(id, layer){
    var el = document.getElementById(id);
    if(!el || !layer) return;
    el.addEventListener('change', function(){
      if(this.checked) layer.addTo(map);
      else map.removeLayer(layer);
      enforceBackLayers();
      fitToActive();
    });
  }

  bindToggle('ck_colabora', camadaColabora);
  bindToggle('ck_fronteiras', camadaFronteiras);
  bindToggle('ck_agenda', camadaAgenda);
  bindToggle('ck_solucoes', camadaSolucoes);
  bindToggle('ck_uc', camadaUC);
  bindToggle('ck_ti', camadaTI);
  bindToggle('ck_mun', camadaMunicipios);

  // garante layout certo depois de carregar
  window.addEventListener('load', function(){
    map.invalidateSize();
  });
  // ============================
  // BUSCA (LIVRE) NOS ATRIBUTOS ‚Äî ATUALIZADA
  // (com suporte a Munic√≠pio com acento e ignorando "-" / vazios)
  // ============================

  // 1) Config: em quais camadas buscar
  var SEARCH_LAYERS = [
    { layer: camadaColabora,   label: 'Co-Labora' },
    { layer: camadaFronteiras, label: 'Fronteiras T2' },
    { layer: camadaAgenda,     label: 'Agenda P√∫blica' },
    { layer: camadaSolucoes,   label: 'Solu√ß√µes Locais' }
  ];

  // 2) UI (garanta que o CSS .search-ctrl etc. j√° esteja no <style>)
  var searchCtrl = document.createElement('div');
  searchCtrl.className = 'search-ctrl open';
  searchCtrl.innerHTML = `
    <div class="search-head">
      <span class="search-pill">Buscar</span>
      <input id="searchInput" class="search-input" type="text"
            placeholder="Buscar por qualquer palavra (ex: Ga√∫cha, T1, Mobiliza√ß√£o)..." />
    </div>
    <div id="searchResults" class="search-results"></div>
  `;
  document.body.appendChild(searchCtrl);

  var searchInput = document.getElementById('searchInput');
  var searchResults = document.getElementById('searchResults');

  // 3) Helpers

  // Campos candidatos pra t√≠tulo (s√≥ visual)
  var TITLE_FIELDS = [
    'Nome_area','nome_area','Comunidade','comunidade','Nome','nome','Local','local',
    'Project','project','Categoria','categoria'
  ];

  // remove acentos (recomendado)
  function normText(s){
    return String(s || '')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,''); // tira acentos
  }

  // trata valores ‚Äúvazios‚Äù
  function isMissing(v){
    if(v===null || v===undefined) return true;
    var s = String(v).trim();
    if(!s) return true;
    s = s.toLowerCase();
    return (s === '-' || s === 'null' || s === 'nan' || s === 'undefined');
  }

  function pickFirst(props, keys){
    for(var i=0;i<keys.length;i++){
      var k = keys[i];
      if(!props || props[k] === undefined) continue;
      if(!isMissing(props[k])) return String(props[k]).trim();
    }
    return '';
  }

  function buildSearchBlob(props){
    var parts = [];
    Object.keys(props || {}).forEach(function(k){
      // respeita sua blacklist do popup
      if(POPUP_BLACKLIST && POPUP_BLACKLIST.has(k)) return;

      var v = props[k];
      if(isMissing(v)) return;

      parts.push(String(v).trim());
    });
    return normText(parts.join(' '));
  }

  function getTitle(props){
    if(!props) return '';
    for(var i=0;i<TITLE_FIELDS.length;i++){
      var k = TITLE_FIELDS[i];
      if(props[k] !== undefined && !isMissing(props[k])) return String(props[k]).trim();
    }

    // fallback: tenta Munic√≠pio (com acento) e variantes
    var mun = pickFirst(props, ['Munic√≠pio','Municipio','municipio','MUNICIPIO','NM_MUN','nm_mun','NOME_MUN','nome_mun']);
    return mun || '(sem nome)';
  }

  // Linha secund√°ria do resultado (camada + munic√≠pio + UF + etc)
  function getMetaLine(props, layerLabel){
    var mun = pickFirst(props, [
      'Munic√≠pio', 'Municipio', 'municipio', 'MUNICIPIO',
      'NM_MUN', 'nm_mun', 'NOME_MUN', 'nome_mun',
      'Municipio_nome', 'municipio_nome'
    ]);

    var uf  = pickFirst(props, ['UF','uf']);
    var cat = pickFirst(props, ['Categoria','categoria']);
    var tri = pickFirst(props, ['Trimestre','trimestre']);

    var meta = [];
    if(layerLabel) meta.push(layerLabel);
    if(mun) meta.push(mun);
    if(uf)  meta.push(uf);
    if(cat) meta.push(cat);
    if(tri) meta.push(tri);
    return meta.join(' ‚Ä¢ ');
  }

  // retorna um latlng "bom" para pol√≠gonos e pontos
  function layerToLatLng(l){
    if(l.getLatLng) return l.getLatLng();
    if(l.getBounds) return l.getBounds().getCenter();
    return null;
  }

  // 4) Index
  var SEARCH_INDEX = [];
  function rebuildSearchIndex(){
    SEARCH_INDEX = [];

    SEARCH_LAYERS.forEach(function(item){
      if(!item.layer) return;

      item.layer.eachLayer(function(l){
        var f = l.feature;
        if(!f || !f.properties) return;

        var ll = layerToLatLng(l);
        if(!ll) return;

        var props = f.properties;
        var title = getTitle(props);
        var blob  = buildSearchBlob(props);
        if(!blob) return;

        SEARCH_INDEX.push({
          title: title,
          title_norm: normText(title),
          metaLine: getMetaLine(props, item.label),
          latlng: ll,
          layerRef: l,
          blob: blob
        });
      });
    });

    SEARCH_INDEX.sort(function(a,b){
      return a.title.localeCompare(b.title,'pt-BR');
    });
  }
  rebuildSearchIndex();

  // 5) Render
  function clearResults(){
    searchResults.innerHTML = '';
    searchCtrl.classList.remove('open');
  }

  function showResults(list){
    if(!list.length){ clearResults(); return; }

    var html = '';
    list.slice(0, 25).forEach(function(r){
      html += `
        <div class="search-item">
          <strong>${escapeHtml(r.title)}</strong>
          <small>${escapeHtml(r.metaLine || '')}</small>
        </div>
      `;
    });

    searchResults.innerHTML = html;
    searchCtrl.classList.add('open');

    searchResults.querySelectorAll('.search-item').forEach(function(el, idx){
      el.addEventListener('click', function(){
        zoomToResult(list[idx]);
      });
    });
  }

  function zoomToResult(r){
    map.setView(r.latlng, Math.max(map.getZoom(), 11), { animate:true });

    if(r.layerRef.getBounds){
      var b = r.layerRef.getBounds();
      if(b && b.isValid()) map.fitBounds(b, {padding:[30,30], maxZoom:13});
    }

    if(r.layerRef.openPopup) r.layerRef.openPopup();
    clearResults();
  }

  // 6) Busca
  function doSearch(q){
    q = normText(String(q||'').trim());
    if(q.length < 2){ clearResults(); return; }

    var tokens = q.split(/\s+/).filter(Boolean);

    var matches = SEARCH_INDEX.filter(function(r){
      for(var i=0;i<tokens.length;i++){
        if(!r.blob.includes(tokens[i])) return false;
      }
      return true;
    });

    // ranking: prioriza hits no t√≠tulo
    matches.sort(function(a,b){
      var aScore = 0, bScore = 0;
      tokens.forEach(function(t){
        if(a.title_norm.includes(t)) aScore += 2;
        if(b.title_norm.includes(t)) bScore += 2;
      });
      if(aScore !== bScore) return bScore - aScore;
      return a.title.localeCompare(b.title,'pt-BR');
    });

    showResults(matches);
  }

  searchInput.addEventListener('input', function(){
    doSearch(this.value);
  });

  searchInput.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){
      this.value = '';
      clearResults();
    }
    if(e.key === 'Enter'){
      var q = normText(this.value.trim());
      if(q.length < 2) return;

      // tenta primeiro no blob (qualquer atributo), depois no t√≠tulo
      var first = SEARCH_INDEX.find(function(r){ return r.blob.includes(q); });
      if(!first) first = SEARCH_INDEX.find(function(r){ return r.title_norm.includes(q); });
      if(first) zoomToResult(first);
    }
  });

  // fecha resultados ao clicar fora
  document.addEventListener('click', function(e){
    if(!searchCtrl.contains(e.target)) clearResults();
  });
</script>
</body>
</html>